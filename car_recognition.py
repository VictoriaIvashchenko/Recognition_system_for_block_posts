"""
Модуль для детекції автомобілів у відеопотоці за допомогою моделі YOLO.

Цей модуль використовує бібліотеку Ultralytics для завантаження та використання моделі YOLO
(версія 8) з вагами `yolov8n.pt`. Основна функція `detect_cars_from_video` виконує обробку
відеопотоку, зчитуючи кадри, застосовуючи модель YOLO для детекції об'єктів, і перевіряючи
наявність автомобілів (клас 2 згідно з COCO dataset).

Основні можливості:
- Завантаження моделі YOLO для виконання детекції.
- Аналіз кожного кадру відео для визначення, чи є на ньому автомобіль.
- Оновлення глобальної змінної `parameters.GLOBAL_VAR` залежно від результатів детекції.

Функції:
- detect_cars_from_video(cap): Обробляє відеопотік, детектує автомобілі та оновлює
  глобальну змінну `parameters.GLOBAL_VAR`.

Залежності:
- Бібліотека `ultralytics` для роботи з моделлю YOLO.
- Модуль `parameters`, який містить глобальну змінну `parameters.GLOBAL_VAR`.

Примітки:
- Модуль розрахований на використання з COCO dataset (класифікація об'єктів).
- Відеопотік закривається автоматично після завершення обробки (`cap.release()`).
- Потребує попередньо завантажену модель YOLO з вагами `yolov8n.pt`.
"""
from ultralytics import YOLO
import parameters


def detect_cars_from_video(cap):
    """
       Виконує детекцію автомобілів на кожному кадрі відеопотоку за допомогою моделі YOLO.

       Ця функція обробляє відеопотік, зчитуючи кадри з об'єкта `cap` (cv2.VideoCapture),
       виконує детекцію об'єктів на кожному кадрі, перевіряє, чи є серед них автомобілі,
       та оновлює глобальну змінну `parameters.GLOBAL_VAR` залежно від результатів.

       Параметри:
       cap (cv2.VideoCapture): Об'єкт відеозахоплення, з якого зчитуються кадри.

       Використання:
       - Передайте відкрите відео (`cv2.VideoCapture`) як параметр.
       - Функція закриває ресурс `cap` автоматично після завершення роботи.

       Деталі роботи:
       - Завантажується модель YOLO v8 із вагами `yolov8n.pt`.
       - Перевіряються результати детекції для кожного кадру.
       - Якщо знайдено об'єкт із класом `2` (автомобіль, згідно з COCO dataset),
         глобальна змінна `parameters.GLOBAL_VAR` оновлюється до `True`, інакше — `False`.

       Залежності:
       - Модель YOLO повинна бути попередньо завантажена та доступна як "yolov8n.pt".
       - Змінна `parameters.GLOBAL_VAR` має бути визначена перед викликом функції.

       Приклад:
       cap = cv2.VideoCapture("video.mp4")
       detect_cars_from_video(cap)

       Примітки:
       - Відеопотік буде закрито автоматично (`cap.release()`).
       - Функція обробляє лише класифіковані об'єкти та не відображає результати.
       """
    model = YOLO("yolov8n.pt")

    while cap.isOpened():
        ret, frame = cap.read()
        if not ret:
            break

        results = model(frame)

        car_detected = False
        for result in results[0].boxes:
            class_id = int(result.cls)
            if class_id == 2:
                car_detected = True

        parameters.GLOBAL_VAR = car_detected

    cap.release()
